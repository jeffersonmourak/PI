<polymer-element name="pi-player" attributes="mpFourVideo webmVideo width height youtube" >
	<template>
		<style>
			.hide{
				display: none;
			}
			.show{
				display: block;
			}
			.buffer{
				background-color: rgba(220,220,220,1);
				vertical-align: middle;
				border: none;
				height: 5px;
				width: 300px;
				position: absolute;
				top:12.51px;
				left: 2px;
				margin-right: 100px;
				margin-left: 100px;
			}
			.played{
				background-color: #f4e738;
				height: 5px;
				position: absolute;
				top:12.51px;
				left: 0px;
				margin-right: 100px;
				margin-left: 101px;
				width: 300px;
			}
			.annotation{
				font-family: "Montserrat";
				margin:8px;
				padding: 5px;
			}
		</style>
		<div id="styleImport">
			<link rel="stylesheet" href="PI_Data/css/style.css">
		</div>
		<div id='label' class="hide">{{display.label}}</div>
		<div id="annotation" class="annotation" style="display: {{annotationStatus}}; width: {{VisibleAnnotation.width}} ; height: {{VisibleAnnotation.height}} ; top : {{VisibleAnnotation.top}} ; left : {{VisibleAnnotation.left}} ; background-color: {{VisibleAnnotation.style.background}} ; color: {{VisibleAnnotation.style.foreColor}} ;position: relative;"> {{VisibleAnnotation.text}} </div>
		<video id="video" style="background-color:#000;" on-mousemove=" {{move}} ">
			
		</video>
		<div id="mediaControls" class='media-controls show'>
			<span id="play" class="play" title="{{buttons.play.title}}"><img class="Control-Buttons" src="{{buttons.play.icon}}"></span>
			<span id='stop' class='stop' title='{{buttons.stop.title}}'><img class="Control-Buttons" src="{{buttons.stop.icon}}"></span>
    	    <span id="volume" title='{{buttons.volume.mute.title}}'><img class="Control-Buttons" src="{{buttons.volume.mute.icon}}"></span>
    	    <div id="bufferBar" class="buffer"></div>
    	    <div id="relativeBar" class="played"></div>
    	    <input id='progress' class='progress' type="range" name="points" step='1' value="0" min="0" max="100">
    	    <div id="volumeControls" class="hide volumeControls">
    	    	<span id='volUp' class='volume-plus' title='increase volume'><img class="Control-Buttons" src="PI_Data/images/volumeUp.svg"></span>
    			<span id='volDown' class='volume-minus' title='decrease volume'><img class="Control-Buttons" src="PI_Data/images/volumeDown.svg"></span>
    			<span id='mute' class='mute' title='{{buttons.volume.mute.title}}'><img class="Control-Buttons" src="{{buttons.volume.mute.icon}}"></span>
    	    </div>
    	</div>
	</template>
	<script>
		Polymer('pi-player', {
			buttons : {
				play : {
					icon : "PI_Data/images/play.svg",
					title : "Play",
				},
				stop : {
					icon : "PI_Data/images/stop.svg",
					title : "Stop",
				},
				volume : {
					mute : {
						icon : "PI_Data/images/mute.svg",
						title : "Mute",
					}
				}
			},
			icons : {
				play : "play",
				pause : "pause",
				stop : "stop",
				mute : "mute",
				unmute : "unmute",
			},
			VisibleAnnotation : {
				text : "",
				width : "200px",
				height : "80px",
				top : "0px",
				left : "0px",
				style : {
					background : "rgba(255,0,0,0.7)",
					foreColor : "rgba(255,255,255,1)"
				}
			},
			annotationStatus : "none",
			annotation :[],
			sources : "",
			configs: {
				enter : false
			},
			videoTime : "0:0",
			moving : new Event("MouseMove"),
			youtubeReady: new Event("youtubeReady"),
			move : function(){
				var $scope = this.$;
				var mediaPlayer = $scope.video;
				mediaPlayer.dispatchEvent(this.moving);
			},
			response :"",
			youtubeID : "",
			ready : function(){
				var $scope = this.$,
					$data = this;
				function loadXMLDoc(){
					var xmlhttp = new XMLHttpRequest();
					xmlhttp.onreadystatechange = function(){
						if (xmlhttp.readyState==4 && xmlhttp.status==200){
							$data.response=xmlhttp.responseText;
						}
					}
					xmlhttp.open("GET","http://jeffersonmourak.com/yt.php?v="+$data.youtubeID,true);
					xmlhttp.send();
					xmlhttp.onreadystatechange = function(){
						if (xmlhttp.readyState === 4) {
							if (xmlhttp.status === 200) {
								$data.response = JSON.parse(xmlhttp.responseText); 
								mediaPlayer.dispatchEvent($data.youtubeReady);
							} else {
								console.error('There was a problem with the request.');
							}
						}
					}
				}
				// Start Ready funcion
				$data.annotation.sort(function(a,b){
					return b.start - a.start;
				});
				$data.annotation.reverse();
				
				if($data.youtube !== undefined){
					$data.youtubeID = $data.youtube;
					loadXMLDoc();
				}
				if($data.webmVideo !== undefined){
					$data.sources += "<source src=\""+$data.webmVideo+"\" type=\"video/webm\"></source>";
				}
				if($data.mpFourVideo !== undefined){
					$data.sources += "<source src=\""+$data.mpFourVideo+"\" type=\"video/mp4\"></source>";
				}
				//video Controls
				var ischanging = false;
				var progressBar = $scope.progress;
				$scope.video.innerHTML = $data.sources;
				var mediaPlayer = $scope.video;
				mediaPlayer.addEventListener('loadeddata', function() {
					if($data.width !== undefined || $data.height !== undefined){
						mediaPlayer.style = "width:"+$data.width+"px; height:"+$data.height+"px;";
					}
					else if($data.width === undefined || $data.height !== undefined){
						mediaPlayer.style = "height:"+$data.height+"px;";
					}
					else if($data.width !== undefined || $data.height === undefined){
						mediaPlayer.style = "width:"+$data.width+"px;";
					}
					$scope.mediaControls.style = "width:"+ (mediaPlayer.clientWidth - 10) + "px";
					progressBar.style = "width:"+ (mediaPlayer.clientWidth - 110) + "px; background-color: transparent;";
					BufferedValue();
				});

				function BufferedValue(){	
					setInterval(function(){
						var percentage = Math.floor((100 / mediaPlayer.duration) * mediaPlayer.currentTime);
						var TotalSize = mediaPlayer.clientWidth - 110;
						var r = mediaPlayer.buffered;
						var bEnd = r.end(0);
						var buffered = Math.floor((bEnd/mediaPlayer.duration) * 100);
						var RelativeSize = (TotalSize * buffered)/100;
						var PlayedSize = (TotalSize * percentage)/100;
						$scope.relativeBar.className = "played";
						$scope.bufferBar.className = "buffer";
						$scope.relativeBar.style = "width:"+ (PlayedSize + 1) + "px;";
						$scope.bufferBar.style = "width:"+ (RelativeSize - 2) + "px;";
					},500);
				}

				var mouseMoving = 0;
				mediaPlayer.addEventListener("MouseMove",function(){
					var controls = $scope.mediaControls;
					controls.className = "media-controls show";
					mouseMoving += 1;
				},false);
				var oldMouse = 0;
				setInterval(function(){
					var controls = $scope.mediaControls;
					if(oldMouse == mouseMoving){
						if(!mediaPlayer.paused){
							controls.className = "media-controls hide";
						}
					}
					else{
						oldMouse = mouseMoving;
					}
				},2000);
				function label(text){
					var labelOb = $scope.label;
					labelOb.className= "label show";
					labelOb.innerHTML = text;
					setTimeout(function(){
						label.className = "label hide";
					},2000);
				}
				function getDuration(time){
					var minutesTime = time/60;
					var minutes = Math.floor(minutesTime);
					var seconds = Math.round((minutesTime - minutes)*60);
					return {
						minutes : minutes,
						seconds : seconds,
					};
				}
				var oldTIme;
				var inAnnotation = false;
				var i = 0;
				function updateProgressBar() {
					if(!ischanging){
						var percentage = Math.floor((100 / mediaPlayer.duration) *
						mediaPlayer.currentTime);
						progressBar.value = percentage;
						progressBar.innerHTML = percentage + '% played';
						var time = getDuration(mediaPlayer.currentTime);
						var CurrentTime = time.minutes + ":" + time.seconds;
						if(CurrentTime != oldTIme){
							$data.videoTime = CurrentTime;
							oldTIme = CurrentTime;
							if(!inAnnotation){
								if(i != $data.annotation.length){
									if($data.annotation[i].start == CurrentTime){
										inAnnotation = true;
										$data.VisibleAnnotation = $data.annotation[i].parameters;
										$data.annotationStatus = "block";
									}
								}
							}
							else{
								if($data.annotation[i].end == CurrentTime){
									
									$data.annotationStatus = "none";
									inAnnotation = false;
									i+=1;
								}
							}
						}
					}
				}
				function togglePlayPause(){
					var btn = $scope.play;
					if (mediaPlayer.paused || mediaPlayer.ended) {
						$data.buttons.play.icon = "PI_Data/images/pause.svg";
						$data.buttons.play.title = "Pause";
						btn.className = 'pause';
						mediaPlayer.play();
						label("Playing");
						var controls = $scope.mediaControls;
						controls.className = "media-controls show";
						setTimeout(function(){
							if(!mediaPlayer.paused){
								controls.className = "media-controls hide";
							}
						},2000);
					}
					else {
						$data.buttons.play.icon = "PI_Data/images/play.svg";
						$data.buttons.play.title = "Play";
						btn.className = 'play';
						mediaPlayer.pause();
						label("Paused");
						$scope.mediaControls.className = "media-controls show";
					}
				}
				function stopPlayer() {
					$data.buttons.play.icon = "PI_Data/images/play.svg";
					$data.buttons.play.title = "Play";
					mediaPlayer.pause();
					mediaPlayer.currentTime = 0;
					progressBar.value = 0;
					label("Stoped");
				}
				function changeVolume(direction) {
					if (direction === '+') mediaPlayer.volume += mediaPlayer.volume == 1 ? 0 : 0.1;
					else mediaPlayer.volume -= (mediaPlayer.volume == 0 ? 0 : 0.1);
					mediaPlayer.volume = parseFloat(mediaPlayer.volume).toFixed(1);
					label("Volume " + (mediaPlayer.volume * 100) + "%");
				}
				function toggleMute() {
					if (mediaPlayer.muted) {
						$data.buttons.volume.mute.icon = "PI_Data/images/mute.svg";
						$data.buttons.volume.mute.title = "Mute";
						mediaPlayer.muted = false;
						label("Volume " + (mediaPlayer.volume * 100) + "%");
					}
					else {
						$data.buttons.volume.mute.icon = "PI_Data/images/unmute.svg";
						$data.buttons.volume.mute.title = "Unmute";
						mediaPlayer.muted = true;
						label("Volume 0%");
					}

				}
				function showVolumeCtrls(){
					var volumeCtrls = $scope.volumeControls;
					if(volumeCtrls.className == "hide volumeControls"){
						volumeCtrls.className = "show volumeControls";
					}
					else{
						volumeCtrls.className = "hide volumeControls";
					}
				}
				var playButton = $scope.play;	
				var stopButton = $scope.stop;
				var player = $scope.video;
				var volumeButtons = {
					up : $scope.volUp,
					down : $scope.volDown,
					mute : $scope.mute,
					controls : $scope.volume,
				};
				volumeButtons.up.addEventListener("click",function(){changeVolume("+");},false);
				volumeButtons.down.addEventListener("click",function(){changeVolume("-");},false);
				volumeButtons.mute.addEventListener("click",toggleMute,false);
				volumeButtons.controls.addEventListener("click",showVolumeCtrls,false);
				stopButton.addEventListener("click",stopPlayer,false);
				playButton.addEventListener("click",togglePlayPause,false);
				player.addEventListener("click",togglePlayPause,false);
				mediaPlayer.addEventListener('timeupdate', updateProgressBar, false);
				mediaPlayer.controls = false;
				mediaPlayer.addEventListener("youtubeReady",function(){
					var DownloadList = $data.response;
					for(var inc = 0; inc < DownloadList.length; inc+=1){
						var downloadOption = DownloadList[inc];
						if(downloadOption.quality == "medium" && downloadOption.type.contains("video/mp4")){
							$data.mpFourVideo = downloadOption.url;
							$data.sources += "<source src=\""+$data.mpFourVideo+"\" type=\"video/webm\"></source>";
						}
						if(downloadOption.quality == "medium" && downloadOption.type.contains("video/webm")){
							$data.webmVideo = downloadOption.url;
							$data.sources += "<source src=\""+$data.webmVideo+"\" type=\"video/webm\"></source>";
						}
					}
					$scope.video.innerHTML = $data.sources;
				},false);
				progressBar.addEventListener("input", function() {
					var ctime = Math.floor((mediaPlayer.duration * progressBar.value)/100);
					mediaPlayer.currentTime = ctime;
					ischanging = true;
				}, false);
				progressBar.addEventListener("change", function() {
					ischanging = false;
				}, false);
			// end of ready function
			}
		});
	</script>
</polymer-element>
<script>
	var pi = {
		setAnnotation : function(selector, options){
			var obj = document.querySelector(selector);
			if(options.start === undefined){
				console.error("start time undefined");
			}
			if(options.end === undefined){
				console.error("end time undefined");
			}
			if(options.parameters.text === undefined){
				console.error("text time undefined");
			}
			if(options.parameters.width === undefined){
				console.error("width time undefined");
			}
			if(options.parameters.height === undefined){
				console.error("height time undefined");
			}
			if(options.parameters.top === undefined){
				console.error("top time undefined");
			}
			if(options.parameters.width === undefined){
				console.error("left time undefined");
			}
			if(options.parameters.width === undefined){
				console.error("background time undefined");
			}
			if(options.parameters.width === undefined){
				console.error("foreColor time undefined");
			}
			obj.__proto__.annotation[obj.annotation.length] = options;
		}
	}
</script>